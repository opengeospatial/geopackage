== Options

The optional capabilities specified in this clause depend on the required capabilities specified in clause <<_base>> above.

________________________________________________________________________________________________________________________
*Req {counter:req}:* A Valid GeoPackage SHALL contain features per clause <<_features>> and/or tiles per clause
<<_tiles>> and row(s) in the `gpkg_contents` table with lowercase `data_type` column values of “features” and/or “tiles”
describing the user data tables.
________________________________________________________________________________________________________________________

=== Features

The optional capabilities defined in sub clauses and requirement statements of this clause MAY be implemented by any
GeoPackage file.

[[sfsql_intro]]
==== Simple Features SQL Introduction

Vector feature data represents geolocated entities including conceptual ones such as districts, real world objects such
as roads and rivers, and observations thereof. International specifications <<N13>><<N14>><<N15>><<N16>> have standardized
practices for the storage, access and use of vector geospatial features and geometries via SQL in relational databases.
The first component of the SQL schema for vector features in a GeoPackage is the `gpkg_spatial_ref_sys` table defined in
clause <<spatial_ref_sys>> above. Other components are defined below.

In a GeoPackage file, “simple” features are geolocated using a linear geometry subset of the SQL/MM (ISO 13249-3) <<N16>>
geometry model shown in <<core_geometry_model_figure>> below.

[[core_geometry_model_figure]]
.Core Geometry Model
image::core-geometry-model.png[Core geometry model]

The instantiable (not abstract) geometry types defined in this Standard are restricted to 0, 1 and 2-dimensional
geometric objects that exist in 2, 3 or 4-dimensional coordinate space (R2, R3 or R4). Geometry values in R2 have points
with coordinate values for x and y. Geometry values in R3 have points with coordinate values for x, y and z or for x, y
and m. Geometry values in R4 have points with coordinate values for x, y, z and m. The interpretation of the coordinates
is subject to the coordinate reference systems associated to the point. All coordinates within a geometry object should
be in the same coordinate reference systems.

Geometries MAY include z coordinate values. The z coordinate value traditionally represents the third dimension (i.e.
3D). In a Geographic Information System (GIS) this may be height above or below sea level. For example: A map might have
a point identifying the position of a mountain peak by its location on the earth, with the x and y coordinate values,
and the height of the mountain, with the z coordinate value.

Geometries MAY include m coordinate values. The m coordinate value allows the application environment to associate some
measure with the point values. For example: A stream network may be modeled as multilinestring value with the m
coordinate values measuring the distance from the mouth of stream.

All geometry types described in this standard are defined so that instances of Geometry are topologically closed, i.e.
all represented geometries include their boundary as point sets. This does not affect their representation, and open
version of the same classes MAY be used in other circumstances, such as topological representations.

A brief description of each geometry type is provided below. A more detailed description can be found in ISO 13249-3 <<N16>>.

* Geometry: the root of the geometry type hierarchy.
* Point: a single location in space. Each point has an X and Y coordinate. A point MAY optionally also have a Z and/or
  an M value.
* Curve: the base type for all 1-dimensional geometry types. A 1-dimensional geometry is a geometry that has a length,
  but no area. A curve is considered simple if it does not intersect itself (except at the start and end point). A curve
  is considered closed its start and end point are coincident. A simple, closed curve is called a ring.
* LineString: A Curve that connects two or more points in space.
* Surface: the base type for all 2-dimensional geometry types. A 2-dimensional geometry is a geometry that has an area.
* CurvePolygon: A planar surface defined by an exterior ring and zero or more interior ring. Each ring is defined by a
  Curve instance.
* Polygon: A restricted form of CurvePolygon where each ring is defined as a simple, closed LineString.
* GeometryCollection: A collection of zero or more Geometry instances.
* MultiSurface: A restricted form of GeometryCollection where each Geometry in the collection must be of type Surface.
* MultiPolygon: A restricted form of MultiSurface where each Surface in the collection must be of type Polygon.
* MultiCurve: A restricted form of GeometryCollection where each Geometry in the collection must be of type Curve.
* MultiLineString: A restricted form of MultiCurve where each Curve in the collection must be of type LineString.
* MultiPoint: A restricted form of GeometryCollection where each Geometry in the collection must be of type Point.

==== Contents

===== Data

====== Contents Table – Features Row

________________________________________________________________________________________________________________________
*Req {counter:req}:* The `gpkg_contents` table SHALL contain a row with a lowercase `data_type` column value of
“features” for each vector features user data table or view.
________________________________________________________________________________________________________________________

==== Geometry Encoding

===== Data

[[gpb_format]]
====== BLOB Format

________________________________________________________________________________________________________________________
*Req {counter:req}:* A GeoPackage file SHALL store feature table geometries with or without optional elevation (Z)
and/or measure (M) values in SQL BLOBs using the GeoPackageBinary format specified in 4 and clause 2.1.3.1.1.
________________________________________________________________________________________________________________________

:geopackage_binary_foot1: footnote:[OGC WKB simple feature geometry types specified in <<N13>> are a subset of the ISO WKB geometry types specified in <<N16>>]

.GeoPackage SQL Geometry Binary Format
----
GeoPackageBinary {
  byte[2] magic = 0x4750; <1>
  byte version;           <2>
  byte flags;             <3>
  int32 srs_id;
  double[] envelope;      <4>
  WKBGeometry geometry;   <5>
}
----

<1> 'GP' in ASCII
<2>  8-bit unsigned integer, 0 = version 1
<3>  flags layout:
+
....
+============================+
|bit |7 |6 |5 |4 |3 |2 |1 |0 |
|use |R |R |R |Y |E |E |E |B |
+============================+
....
+
* R: reserved for future use; set to 0
* Y: empty geometry flag
** 0: non-empty geometry
** 1: empty geometry
* E: envelope contents indicator code (3-bit unsigned integer)
** 0: no envelope (space saving slower indexing option), 0 bytes
** 1: envelope is [minx, maxx, miny, maxy], 32 bytes
** 2: envelope is [minx, maxx, miny, maxy, minz, maxz], 48 bytes
** 3: envelope is [minx, maxx, miny, maxy, minm, maxm], 48 bytes
** 4: envelope is [minx, maxx, miny, maxy, minz, maxz, minm, maxm], 64 bytes
** 5-7: invalid
* B: byte order for header values (1-bit Boolean)
** 0: Big Endian (most significant byte first)
** 1: Little Endian (least significant byte first)
<4>  see flags envelope contents indicator code below
<5>  per  ISO 13249-3 <<N16>> clause 5.1.46 {geopackage_binary_foot1}

Well-Known Binary as defined in ISO 13249-3 <<N16>> does not provide a standardized encoding for an empty point set (i.e.,
'Point Empty' in Well-Known Text). In GeoPackage files these points SHALL be encoded as a Point where each coordinate
value is set to an IEEE-754 quiet NaN value. GeoPackage files SHALL use big endian 0x7ff8000000000000 or little
endian 0x000000000000f87f as the binary encoding of the NaN values.

===== API

====== Minimal Runtime SQL Functions

:min_runtime_foot1: footnote:[Functions other than the minimal runtime SQL functions required by triggers in a GeoPackage file SHOULD be documented in the gpkg_extensions table and provided by a GeoPackage SQLite Extension.]
:min_runtime_foot2: footnote:[SQL functions on geometries in addition to those defined in this clause SHOULD conform to the SF/SQL <<N13>><<N14>><<N15>> and SQL/MM <<N16>> specifications cited in clause <<sfsql_intro>> above.

In contrast to functions in application code or a runtime library, triggers are part of the SQLite database file. When
an application writes to a GeoPackage file that it did not create itself then there is the possibility that it will
invoke a trigger that calls a function that the application’s runtime library does not provide. To avoid this
interoperability problem, a small set of functions on the GeoPackageBinary geometry specified in clause <<gpb_format>>
are defined in <<minimal_runtime_sql_functions>>. Every implementation can be sure that triggers that only use these
functions in addition to those provided by SQLite will work as intended across implementations. {min_runtime_foot1}
{min_runtime_foot2}

________________________________________________________________________________________________________________________
*Req {counter:req}:* A GeoPackage SQLite Extension MAY provide SQL function support for triggers in GeoPackage file. One
that does so SHALL provide the minimal runtime SQL functions listed in Annex D Table 36.
________________________________________________________________________________________________________________________

==== Geometry Types

===== Data

====== Core Types

________________________________________________________________________________________________________________________
*Req {counter:req}:* A GeoPackage file SHALL store feature table geometries with the basic simple feature geometry types
(Geometry, Point, LineString, Polygon, MultiPoint, MultiLineString, MultiPolygon, GeomCollection) in <<geometry_types>>
<<geometry_types_core>> in the GeoPackageBinary geometry encoding format.
________________________________________________________________________________________________________________________

==== Geometry Columns

===== Data

====== Table Definition

________________________________________________________________________________________________________________________
*Req {counter:req}:* A GeoPackage file with a `gpkg_contents` table row with a “features” `data_type` SHALL contain a
`gpkg_geometry_columns` table or updateable view per <<gpkg_geometry_columns_cols>> and <<gpkg_geometry_columns_sql>>.
________________________________________________________________________________________________________________________

The second component of the SQL schema for vector features in a GeoPackage is a `gpkg_geometry_columns` table that
identifies the geometry columns in tables that contain user data representing features.

[[gpkg_geometry_columns_cols]]
.Geometry Columns Table or View Definition
[cols=",,,",options="header",]
|=======================================================================
|Column Name |Type |Description |Key
|`table_name` |text |Name of the table containing the geometry column |PK, FK
|`column_name` |text |Name of a column in the feature table that is a Geometry Column |PK
|`geometry_type_name` |text |Name from <<geometry_types_core>> or <<geometry_types_extension>> in <<geometry_types>> |
|`srs_id` |integer |Spatial Reference System ID: `gpkg_spatial_ref_sys.srs_id` |FK
|`z` |integer |0: z values prohibited; 1: z values mandatory; 2: z values optional |
|`m` |integer |0: m values prohibited; 1: m values mandatory; 2: m values optional |
|=======================================================================

The FK on `gpkg_geometry_columns.srs_id` references the PK on `gpkg_spatial_ref_sys.srs_id` to ensure that geometry
columns are only defined in feature tables for defined spatial reference systems.

The `gpkg_geometry_columns` table or view MAY include additional columns to meet the requirements of implementation
software or other specifications. Views of this table or view MAY be used to provide compatibility with the
SQL/MM <<N16>> <<sqlmm_gpkg_geometry_columns_sql>> and OGC Simple Features SQL <<N13>><<N14>><<N15>>
<<sfsql_gpkg_geometry_columns_sql>> specifications.

See <<gpkg_geometry_columns_sql>>.

====== Table Data Values
________________________________________________________________________________________________________________________
*Req {counter:req}:* The `gpkg_geometry_columns` table or updateable view SHALL contain one row record for each geometry
column in each vector feature data table (clause <<feature_user_data_tables>>) in a GeoPackage.
________________________________________________________________________________________________________________________

________________________________________________________________________________________________________________________
*Req {counter:req}:* Values of the `gpkg_geometry_columns` `table_name` column SHALL reference values in the
`gpkg_contents` `table_name` column for rows with a `data_type` of 'features' or 'tiles'.
________________________________________________________________________________________________________________________

________________________________________________________________________________________________________________________
*Req {counter:req}:* The `column_name` column value in a `gpkg_geometry_columns` row SHALL be the name of a column
in the table or view specified by the `table_name` column value for that row.
________________________________________________________________________________________________________________________

________________________________________________________________________________________________________________________
*Req {counter:req}:* The `geometry_type_name` value in a `gpkg_geometry_columns` row SHALL be one of the uppercase
geometry type names specified in <<geometry_types>>.
________________________________________________________________________________________________________________________

________________________________________________________________________________________________________________________
*Req {counter:req}:* The `srs_id` value in a `gpkg_geometry_columns` table row SHALL be an `srs_id` column value from
the `gpkg_spatial_ref_sys` table.
________________________________________________________________________________________________________________________

________________________________________________________________________________________________________________________
*Req {counter:req}:* The z value in a `gpkg_geometry_columns` table row SHALL be one of 0, 1, or 2.
________________________________________________________________________________________________________________________

________________________________________________________________________________________________________________________
*Req {counter:req}:* The m value in a `gpkg_geometry_columns` table row SHALL be one of 0, 1, or 2.
________________________________________________________________________________________________________________________

[[feature_user_data_tables]]
==== Vector Feature User Data Tables

===== Data

====== Table Definition

:features_data_table_foot2: footnote:[A GeoPackage is not required to contain any feature data tables. Feature data tables in a GeoPackage MAY be empty.]

The third component of the SQL schema for vector features in a GeoPackage described in clause <<sfsql_intro>> above are
tables that contain user data representing features. Feature attributes are columns in a feature table, including
geometries. Features are rows in a feature table. {features_data_table_foot2}

________________________________________________________________________________________________________________________
*Req {counter:req}:* A GeoPackage file MAY contain tables or updateable views containing vector features. Every such
feature table or view in a GeoPackage file SHALL have a primary key defined on one integer column per
<<example_feature_table_cols>> and [[example_feature_table_sql]].
________________________________________________________________________________________________________________________

The integer primary key of a feature table allows features to be linked to row level metadata records in the
`gpkg_metadata` table by rowid values in the `gpkg_metadata_reference` table as described in clause
<<_metadata_reference_table>> below.

________________________________________________________________________________________________________________________
*Req {counter:req}:* A feature table SHALL have only one geometry column.
________________________________________________________________________________________________________________________

Feature data models from non-GeoPackage implementations that have multiple geometry columns per feature table MAY be
transformed into GeoPackage implementations with a separate feature table for each geometry type whose rows have
matching integer primary key values that allow them to be joined in a view with the same column definitions as the
non-GeoPackage feature data model with multiple geometry columns.

________________________________________________________________________________________________________________________
*Req {counter:req}:* The columns of a vector feature user data table SHALL only be declared using one of the data types
specified in table <<vector_feature_data_types>>.
________________________________________________________________________________________________________________________

[[vector_feature_data_types]]
.Vector Feature Data Types
[cols=",,,,,",options="header"]
|=======================================================================
|Data Type            | Size and Description
|BOOLEAN              | A boolean value representing true or false. Stored as SQLite INTEGER with value 0 for false or 1 for true
|TINYINT              | 8-bit signed two's complement integer. Stored as SQLite INTEGER with values in the range [-128, 127]
|SMALLINT             | 16-bit signed two's complement integer. Stored as SQLite INTEGER with values in the range [-32768, 32767]
|MEDIUMINT            | 32-bit signed two's complement integer. Stored as SQLite INTEGER with values in the range [-2147483648, 2147483647]
|INT, INTEGER         | 64-bit signed two's complement integer. Stored as SQLite INTEGER with values in the range [-9223372036854775808, 9223372036854775807]
|FLOAT                | 32-bit IEEE floating point number Stored as SQLite REAL limited to values that can be represented as a 4-byte IEEE floating point number
|DOUBLE, REAL         | 64-bit IEEE floating point number Stored as SQLite REAL
|TEXT                 | Variable length string encoded in either UTF-8 or UTF-16, determined by PRAGMA encoding; see http://www.sqlite.org/pragma.html#pragma_encoding Stored as SQLite TEXT
|BLOB                 | Variable length binary data Stored as SQLite BLOB
|<geometry_type_name> | Geometry encoded as per clause 2.1.3 Geometry encoding. <geometry type_name> is one of the geometry types listed in Annex G Geometry Types. XY, XYZ, XYM and XYZM geometries use the same data type. Stored as SQLite BLOB
|DATE                 | ISO-8601 date string encoded in either UTF-8 or UTF-16. See TEXT. Stored as SQLite TEXT
|DATETIME             | ISO-8601 date/time string encoded in either UTF-8 or UTF-16. See TEXT. Stored as SQLite TEXT
|DECIMAL_TEXT(m,d)    | Decimal value with maximum digits (precision) (m) from 1 to 65 and digits to the right of the decimal point (scale) (d) from 0 to 30 1
|=======================================================================

[[example_feature_table_cols]]
.EXAMPLE : Sample Feature Table or View Definition
[cols=",,,,,",options="header"]
|=======================================================================
|Column Name |Type |Description |Null |Default |Key
|`id` |INTEGER |Autoincrement primary key |no | |PK
|`geometry` |GEOMETRY |GeoPackage Geometry |yes | |
|`text_attribute` |TEXT |Text attribute of feature |yes | |
|`real_attribute` |REAL |Real attribute of feature |yes | |
|`boolean_attribute` |BOOLEAN |Boolean attribute of feature |yes | |
|`raster_or_photo` |BLOB |Photograph of the area |yes | |
|=======================================================================

See <<example_feature_table_sql>>.

====== Table Data Values

A feature geometry is stored in a geometry column specified by the lowercase `geometry_column` value for the feature
table in the `gpkg_geometry_columns` table defined in clause <<_geometry_columns>> above.

The geometry type of a feature geometry column specified in the `gpkg_geometry_columns` table `geometry_type_name`
column is a name from <<geometry_types>>.

:geom_type_req_foot1: footnote:[GeoPackage applications MAY use SQL triggers or tests in application code to meet this requirement]
________________________________________________________________________________________________________________________
*Req {counter:req}:* Feature table geometry columns SHALL contain geometries of the type or assignable for the type
specified for the column by the `gpkg_geometry_columns` table `geometry_type_name` column value {geom_type_req_foot1}.
________________________________________________________________________________________________________________________

Geometry subtypes are assignable as defined in <<geometry_types>> and shown in part in <<core_geometry_model_figure>>.
For example, if the `geometry_type_name` value in the `gpkg_geometry_columns` table is for a geometry type like POINT
that has no subtypes, then the feature table geometry column MAY only contain geometries of that type. If the geometry
`type_name` value in the `gpkg_geometry_columns` table is for a geometry type like GEOMCOLLECTION that has subtypes,
then the feature table geometry column MAY only contain geometries of that type or any of its direct or indirect
subtypes. If the geometry `type_name` is GEOMETRY (the root of the geometry type hierarchy) then the feature table
geometry column MAY contain geometries of any geometry type. The presence or absence of optional elevation (Z) and/or
measure (M) values in a geometry does not change its type or assignability.

The spatial reference system type of a feature geometry column specified by a `gpkg_geometry_columns` table `srs_id`
column value is a code from the `gpkg_spatial_ref_sys` table `srs_id` column.

________________________________________________________________________________________________________________________
*Req {counter:req}:* Feature table geometry columns SHALL contain geometries with the `srs_id` specified for the column
by the `gpkg_geometry_columns` table `srs_id` column value.
________________________________________________________________________________________________________________________
